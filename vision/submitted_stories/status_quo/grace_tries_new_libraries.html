<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Grace tries new libraries - wg-async</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wg-async</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/wg-async/edit/master/src/vision/submitted_stories/status_quo/grace_tries_new_libraries.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-grace-tries-new-libraries"><a class="header" href="#-status-quo-stories-grace-tries-new-libraries">ðŸ˜± Status quo stories: Grace tries new libraries</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">ðŸš§ Warning: Draft status ðŸš§</a></h2>
<p>This is a draft "status quo" story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today.</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>When Grace searched crates.io for a library, she found an interesting library that she wants to use. The code examples use a map/reduce style. As Grace is more familiar with C and C++, as a first step she wants to convert them from this style to using loops.</p>
<pre><code class="language-ignore">Controller::new(root_kind_api, ListParams::default())
    .owns(child_kind_api, ListParams::default())
    .run(reconcile, error_policy, context)
    .for_each(|res| async move {
        match res {
            Ok(o) =&gt; info!("reconciled {:?}", o),
            Err(e) =&gt; warn!("reconcile failed: {}", Report::from(e)),
        }
    })
    .await;
</code></pre>
<p>(Example code from taken from https://github.com/clux/kube-rs)</p>
<p>So she takes the naive approach to just convert that as follows:</p>
<pre><code class="language-ignore">let controller = Controller::new(root_kind_api, ListParams::default())
    .owns(child_kind_api, ListParams::default())
    .run(reconcile, error_policy, context);

while let Ok(o) = controller.try_next().await {
    info!("reconciled {:?}", o),
}
</code></pre>
<p>when she compiles her source code she ends up with wall of error messages like the following:</p>
<pre><code class="language-ignore">$ cargo run
   Compiling kube-rs-test v0.1.0 (/home/project-gec/src/kube-rs-test)
error[E0277]: `from_generator::GenFuture&lt;[static generator@watcher&lt;Secret&gt;::{closure#0}::{closure#0} for&lt;'r, 's, 't0, 't1&gt; {ResumeTy, kube::Api&lt;Secret&gt;, &amp;'r kube::Api&lt;Secret&gt;, ListParams, &amp;'s ListParams, watcher::State&lt;Secret&gt;, impl futures::Future, ()}]&gt;` cannot be unpinned
  --&gt; src/main.rs:23:41
   |
23 |     while let Ok(o) = controller.try_next().await {
   |                                  ^^^^^^^^ within `futures_util::unfold_state::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`, the trait `Unpin` is not implemented for `from_generator::GenFuture&lt;[static generator@watcher&lt;Secret&gt;::{closure#0}::{closure#0} for&lt;'r, 's, 't0, 't1&gt; {ResumeTy, kube::Api&lt;Secret&gt;, &amp;'r kube::Api&lt;Secret&gt;, ListParams, &amp;'s ListParams, watcher::State&lt;Secret&gt;, impl futures::Future, ()}]&gt;`
   |
   = note: required because it appears within the type `impl futures::Future`
   = note: required because it appears within the type `futures_util::unfold_state::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures_util::unfold_state::UnfoldState&lt;(kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`
   = note: required because it appears within the type `futures::stream::unfold::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), [closure@watcher&lt;Secret&gt;::{closure#0}], impl futures::Future&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Unfold&lt;(kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), [closure@watcher&lt;Secret&gt;::{closure#0}], impl futures::Future&gt;`
   = note: required because it appears within the type `impl std::marker::Send+futures::Stream`
   = note: required because it appears within the type `futures::stream::try_stream::into_stream::_::__Origin&lt;'_, impl std::marker::Send+futures::Stream&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;`
   = note: required because it appears within the type `futures::stream::stream::map::_::__Origin&lt;'_, futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectFn&lt;futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Map&lt;futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectFn&lt;futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;&gt;`
   = note: required because it appears within the type `futures::stream::stream::_::__Origin&lt;'_, futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Inspect&lt;futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;`
   = note: required because it appears within the type `futures::stream::try_stream::_::__Origin&lt;'_, impl std::marker::Send+futures::Stream, [closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::InspectOk&lt;impl std::marker::Send+futures::Stream, [closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;`
   = note: required because it appears within the type `impl futures::Stream`

error[E0277]: `from_generator::GenFuture&lt;[static generator@watcher&lt;Secret&gt;::{closure#0}::{closure#0} for&lt;'r, 's, 't0, 't1&gt; {ResumeTy, kube::Api&lt;Secret&gt;, &amp;'r kube::Api&lt;Secret&gt;, ListParams, &amp;'s ListParams, watcher::State&lt;Secret&gt;, impl futures::Future, ()}]&gt;` cannot be unpinned
  --&gt; src/main.rs:23:27
   |
23 |     while let Ok(o) = controller.try_next().await {
   |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^ within `futures_util::unfold_state::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`, the trait `Unpin` is not implemented for `from_generator::GenFuture&lt;[static generator@watcher&lt;Secret&gt;::{closure#0}::{closure#0} for&lt;'r, 's, 't0, 't1&gt; {ResumeTy, kube::Api&lt;Secret&gt;, &amp;'r kube::Api&lt;Secret&gt;, ListParams, &amp;'s ListParams, watcher::State&lt;Secret&gt;, impl futures::Future, ()}]&gt;`
   |
   = note: required because it appears within the type `impl futures::Future`
   = note: required because it appears within the type `futures_util::unfold_state::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures_util::unfold_state::UnfoldState&lt;(kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), impl futures::Future&gt;`
   = note: required because it appears within the type `futures::stream::unfold::_::__Origin&lt;'_, (kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), [closure@watcher&lt;Secret&gt;::{closure#0}], impl futures::Future&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Unfold&lt;(kube::Api&lt;Secret&gt;, ListParams, watcher::State&lt;Secret&gt;), [closure@watcher&lt;Secret&gt;::{closure#0}], impl futures::Future&gt;`
   = note: required because it appears within the type `impl std::marker::Send+futures::Stream`
   = note: required because it appears within the type `futures::stream::try_stream::into_stream::_::__Origin&lt;'_, impl std::marker::Send+futures::Stream&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;`
   = note: required because it appears within the type `futures::stream::stream::map::_::__Origin&lt;'_, futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectFn&lt;futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Map&lt;futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectFn&lt;futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;&gt;`
   = note: required because it appears within the type `futures::stream::stream::_::__Origin&lt;'_, futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::Inspect&lt;futures::stream::IntoStream&lt;impl std::marker::Send+futures::Stream&gt;, futures_util::fns::InspectOkFn&lt;[closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;&gt;`
   = note: required because it appears within the type `futures::stream::try_stream::_::__Origin&lt;'_, impl std::marker::Send+futures::Stream, [closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;`
   = note: required because of the requirements on the impl of `Unpin` for `futures::stream::InspectOk&lt;impl std::marker::Send+futures::Stream, [closure@reflector&lt;Secret, impl std::marker::Send+futures::Stream&gt;::{closure#0}]&gt;`
   = note: required because it appears within the type `impl futures::Stream`
   = note: required because of the requirements on the impl of `futures::Future` for `TryNext&lt;'_, impl futures::Stream&gt;`
   = note: required by `futures::Future::poll`

error: aborting due to 2 previous errors

For more information about this error, try `rustc --explain E0277`.
error: could not compile `kube-rs-test`

To learn more, run the command again with --verbose.
</code></pre>
<p>From her background she has an understanding what could go wrong. So she remembered, that she could box the values to solve the issue with calling <code>.boxed()</code> on the controller. But on the other hand she could see no reason why this <code>while</code> loop should fail when the original <code>.for_each()</code> example just works as expected.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ðŸ¤” Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<ul>
<li>Working with async can give huge errors from fairly common place transforms, and requires knowing some "not entirely obvious" workarounds.</li>
</ul>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<ul>
<li>Personal experience.</li>
</ul>
<h3 id="why-did-you-choose-grace-to-tell-this-story"><a class="header" href="#why-did-you-choose-grace-to-tell-this-story"><strong>Why did you choose Grace to tell this story?</strong></a></h3>
<ul>
<li>Reflects the background of the author.</li>
</ul>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<ul>
<li>Ultimately the only way to know how to solve this problem is to have seen it before and learned how to solve it. The compiler doesn't help and the result is not obvious.</li>
<li>So it probably doesn't matter that much which character is used, except that Barbara may be more likely to have seen how to solve it.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../vision/submitted_stories/status_quo/grace_deploys_her_service.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../vision/submitted_stories/status_quo/grace_waits_for_gdb_next.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../mermaid.min.js"></script>
        <script src="../../../mermaid-init.js"></script>


    </div>
    </body>
</html>
