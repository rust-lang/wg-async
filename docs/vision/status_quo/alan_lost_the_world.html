<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Alan lost the world - wg-async-foundations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/tenets.html"><strong aria-hidden="true">2.2.</strong> ‚úèÔ∏è Design tenets for async</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/template.html"><strong aria-hidden="true">2.5.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.5.2.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.5.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.5.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.5.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.5.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item expanded "><a href="../../vision/status_quo/alan_lost_the_world.html" class="active"><strong aria-hidden="true">2.5.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.5.8.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.5.9.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.5.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.5.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.5.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.5.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.5.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.5.15.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.5.16.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.5.17.</strong> Barbara Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.5.18.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">2.5.19.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.5.20.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.5.21.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.5.22.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">2.5.23.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.5.24.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.5.25.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.5.26.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">2.5.27.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.5.28.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.5.29.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.5.30.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.5.31.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.5.32.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.5.33.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/template.html"><strong aria-hidden="true">2.6.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.6.2.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.6.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.6.4.</strong> Barbara makes a wish</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap for 2021</a></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-alan-lost-the-world"><a class="header" href="#-status-quo-stories-alan-lost-the-world">üò± Status quo stories: Alan lost the world!</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../how_to_vision/status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>Alan heard about a project to reimplement a deprecated browser plugin using Rust and WASM. This old technology had the ability to load resources over HTTP; so it makes sense to try and implement that functionality using the Fetch API. Alan looks up the documentation of <code>web_sys</code> and realizes they need to...</p>
<ol>
<li>Call one of the <a href="https://docs.rs/web-sys/0.3.50/web_sys/struct.Window.html#method.fetch_with_request"><code>fetch</code> methods</a>, which returns a <a href="https://docs.rs/js-sys/0.3.50/js_sys/struct.Promise.html"><code>Promise</code></a></li>
<li><a href="https://rustwasm.github.io/wasm-bindgen/api/wasm_bindgen_futures/struct.JsFuture.html">Convert the <code>Promise</code></a> into a Rust thing called a <code>Future</code></li>
<li><code>await</code> the <code>Future</code> in an <code>async</code> function</li>
<li>Do whatever they want with the resulting data</li>
</ol>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use web_sys::{Request, window};

fn make_request(src: &amp;url) -&gt; Request {
    // Pretend this contains all of the complicated code necessary to
    // initialize a Fetch API request from Rust
}

async fn load_image(src: String) {
    let request = make_request(&amp;url);
    window().unwrap().fetch_with_request(&amp;request).await;
    log::error!(&quot;It worked&quot;);
}
<span class="boring">}
</span></code></pre></pre>
<p>Alan adds calls to <code>load_image</code> where appropriate. They realize that nothing is happening, so they look through more documentation and find a thing called <a href="https://rustwasm.github.io/wasm-bindgen/api/wasm_bindgen_futures/fn.spawn_local.html"><code>spawn_local</code></a>. Once they pass the result of <code>load_image</code> into that function, they see their log message pop up in the console, and figure it's time to actually do something to that loaded image data.</p>
<p>At this point, Alan wants to put the downloaded image onto the screen, which in this project means putting it into a <code>Node</code> of the current <code>World</code>. A <code>World</code> is a bundle of global state that's passed around as things are loaded, rendered, and scripts are executed. It looks like this:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>/// All of the player's global state.
pub struct World&lt;'a&gt; {
    /// A list of all display Nodes.
    nodes: &amp;'a mut Vec&lt;Node&gt;,

    /// The last known mouse position.
    mouse_pos &amp;'a mut (u16, u16),

    // ...
}
<span class="boring">}
</span></code></pre></pre>
<p>In synchronous code, this was perfectly fine. Alan figures it'll be fine in async code, too. So Alan adds the world as a function parameter and everything else needed to parse an image and add it to our list of nodes:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn load_image(src: String, inside_of: usize, world: &amp;mut World&lt;'_&gt;) {
    let request = make_request(&amp;url);
    let data = window().unwrap().fetch_with_request(&amp;request).await.unwrap().etc.etc.etc;
    let image = parse_png(data, context);

    let new_node_index = world.nodes.len();
    if let Some(parent) = world.nodes.get(inside_of) {
        parent.set_child(new_node_index);
    }
    world.nodes.push(image.into());
}
<span class="boring">}
</span></code></pre></pre>
<p>Bang! Suddenly, the project stops compiling, giving errors like...</p>
<pre><code class="language-ignore">error[E0597]: `world` does not live long enough
  --&gt; src/motionscript/globals/loader.rs:21:43
</code></pre>
<p>Hmm, okay, that's kind of odd. We can pass a <code>World</code> to a regular function just fine - why do we have a problem here? Alan glances over at <code>loader.rs</code>...</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn attach_image_from_net(world: &amp;mut World&lt;'_&gt;, args: &amp;[Value]) -&gt; Result&lt;Value, Error&gt; {
    let this = args.get(0).coerce_to_object()?;
    let url = args.get(1).coerce_to_string()?;

    spawn_local(load_image(url, this.as_node().ok_or(&quot;Not a node!&quot;)?, world))
}
<span class="boring">}
</span></code></pre></pre>
<p>Hmm, the error is in that last line. <code>spawn_local</code> is a thing Alan had to put into everything that called <code>load_image</code>, otherwise his async code never actually did anything. But why is this a problem? Alan can borrow a <code>World</code>, or anything else for that matter, inside of async code; and it should get it's own lifetime like everything else, right?</p>
<p>Alan has a hunch that this <code>spawn_local</code> thing might be causing a problem, so Alan reads the documentation. The function signature seems particularly suspicious:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn spawn_local&lt;F&gt;(future: F) 
where
    F: Future&lt;Output = ()&gt; + 'static
<span class="boring">}
</span></code></pre></pre>
<p>So, <code>spawn_local</code> only works with futures that return nothing - so far, so good - and are <code>'static</code>. Uh-oh. What does that last bit mean? Alan asks Barbara, who responds that it's the lifetime of the whole program. Yeah, but... the async function is part of the program, no? Why wouldn't it have the <code>'static</code> lifetime? Does that mean all functions that borrow values aren't <code>'static</code>, or just the async ones?</p>
<p>Barbara explains that when you borrow a value in a closure, the closure doesn't gain the lifetime of that borrow. Instead, the borrow comes with it's own lifetime, separate from the closure's. The only time a closure can have a non-<code>'static</code> lifetime is if one or more of its borrows is <em>not</em> provided by it's caller, like so:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn benchmark_sort() -&gt; usize {
    let mut num_times_called = 0;
    let test_values = vec![1,3,5,31,2,-13,10,16];

    test_values.sort_by(|a, b| {
        a.cmp(b)
        num_times_called += 1;
    });

    num_times_called
}
<span class="boring">}
</span></code></pre></pre>
<p>The closure passed to <code>sort_by</code> has to copy or borrow anything not passed into it. In this case, that would be the <code>num_times_called</code> variable. Since we want to modify the variable, it has to be borrowed. Hence, the closure has the lifetime of that borrow, not the whole program, because it can't be called anytime - only when <code>num_times_called</code> is a valid thing to read or write.</p>
<p>Async functions, it turns out, <em>act like closures that don't take parameters</em>! They <em>have to</em>, because all <code>Future</code>s have to implement the same trait method <code>poll</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub trait Future {
    type Output;

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}
<span class="boring">}
</span></code></pre></pre>
<p>When you call an async function, all of it's parameters are copied or borrowed into the <code>Future</code> that it returns. Since we need to borrow the <code>World</code>, the <code>Future</code> has the lifetime of <code>&amp;'a mut World</code>, not of <code>'static</code>.</p>
<p>Barbara suggests changing all of the async function's parameters to be owned types. Alan asks Grace, who architected this project. Grace recommends holding a reference to the <code>Plugin</code> that owns the <code>World</code>, and then borrowing it whenever you need the <code>World</code>. That ultimately looks like the following:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn load_image(src: String, inside_of: usize, player: Arc&lt;Mutex&lt;Player&gt;&gt;) {
    let request = make_request(&amp;url);
    let data = window().unwrap().fetch_with_request(&amp;request).await.unwrap().etc.etc.etc;
    let image = parse_png(data, context);

    player.lock().unwrap().update(|world| {
        let new_node_index = world.nodes.len();
        if let Some(parent) = world.nodes.get(inside_of) {
            parent.set_child(new_node_index);
        }
        world.nodes.push(image.into());
    });
}
<span class="boring">}
</span></code></pre></pre>
<p>It works, well enough that Alan is able to finish his changes and PR them into the project. However, Alan wonders if this could be syntactically cleaner, somehow. Right now, async and update code have to be separated - if we need to do something with a <code>World</code>, then <code>await</code> something else, that requires jumping in and out of this <code>update</code> thing. It's a good thing that we only really <em>have</em> to be async in these loaders, but it's also a shame that we practically <em>can't</em> mix <code>async</code> code and <code>World</code>s.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<ul>
<li><strong>What are the morals of the story?</strong>
<ul>
<li>Async functions capture all of their parameters for the entire duration of the function. This allows them to hold borrows of those parameters across await points.
<ul>
<li>When the parameter represents any kind of &quot;global environment&quot;, such as the <code>World</code> in this story, it may be useful for that parameter not to be captured by the future but rather supplied anew after each await point.</li>
</ul>
</li>
<li>Non-<code>'static</code> Futures are of limited use to developers, as lifetimes are tied to the sync stack. The execution time of most asynchronous operations does not come with an associated lifetime that an executor could use.
<ul>
<li>It is possible to use borrowed futures with <code>block_on</code> style executors, as they necessarily extend all lifetimes to the end of the Future. This is because they turn asynchronous operations back into synchronous ones.</li>
<li>Most practical executors want to release the current stack, and thus all of it's associated lifetimes. They need <code>'static</code> futures.</li>
</ul>
</li>
<li>Async programming introduces more complexity to Rust than it does, say, JavaScript. The complexity of async is <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">sometimes explained in terms of 'color'</a>, where functions of one 'color' can only call those of another under certain conditions, and developers have to keep track of what is sync and what is async. Due to Rust's borrowing rules, we actually have three 'colors', not the two of other languages with async I/O:
<ul>
<li>Sync, or 'blue' in the original metaphor. This color of function can both own and borrow it's parameters. If made into the form of a closure, it may have a lifetime if it borrows something from the current stack.</li>
<li>Owned Async, or 'red' in the original metaphor. This color of function can only own parameters, by copying them into itself at call time.</li>
<li>Borrowed Async. If an async function borrows at least one parameter, it gains a lifetime, and must fully resolve itself before the lifetime of it's parameters expires.</li>
</ul>
</li>
</ul>
</li>
<li><strong>What are the sources for this story?</strong>
<ul>
<li>This is personal experience. Specifically, I had to do <a href="https://github.com/ruffle-rs/ruffle/blob/master/core/src/loader.rs">almost exactly this dance</a> in order to get fetch to work in Ruffle.</li>
<li>I have omitted a detail from this story: in Ruffle, we use a GC library (<code>gc_arena</code>) that imposes a special lifetime on all GC references. This is how the GC library upholds it's memory safety invariants, but it's also what forces us to pass around contexts, and once you have that, it's natural to start putting even non-GC data into it. It also means we can't hold anything from the GC in the Future as we cannot derive it's <code>Collect</code> trait on an anonymous type.</li>
</ul>
</li>
<li><strong>Why did you choose Alan to tell this story?</strong>
<ul>
<li>Lifetimes on closures is already non-obvious to new Rust programmers and using them in the context of Futures is particularly unintuitive.</li>
</ul>
</li>
<li><strong>How would this story have played out differently for the other characters?</strong>
<ul>
<li>Niklaus probably had a similar struggle as Alan.</li>
<li>Grace would have felt constrained by the <code>async</code> syntax preventing some kind of workaround for this problem.</li>
<li>Barbara already knew about Futures and 'static and carefully organizes their programs accordingly.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vision/status_quo/alan_iteratively_regresses.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vision/status_quo/alan_needs_async_in_traits.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vision/status_quo/alan_iteratively_regresses.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vision/status_quo/alan_needs_async_in_traits.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
