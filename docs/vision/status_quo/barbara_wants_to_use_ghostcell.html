<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara wants to use GhostCell-like cell borrowing - wg-async-foundations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/tenets.html"><strong aria-hidden="true">2.2.</strong> ‚úèÔ∏è Design tenets for async</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/template.html"><strong aria-hidden="true">2.5.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.5.2.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.5.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.5.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.5.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.5.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">2.5.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.5.8.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.5.9.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.5.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.5.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.5.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.5.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.5.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.5.15.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.5.16.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.5.17.</strong> Barbara Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.5.18.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">2.5.19.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.5.20.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.5.21.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.5.22.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">2.5.23.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.5.24.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.5.25.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.5.26.</strong> Barbara wants async insights</a></li><li class="chapter-item expanded "><a href="../../vision/status_quo/barbara_wants_to_use_ghostcell.html" class="active"><strong aria-hidden="true">2.5.27.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.5.28.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.5.29.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.5.30.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.5.31.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.5.32.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.5.33.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/template.html"><strong aria-hidden="true">2.6.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.6.2.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.6.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.6.4.</strong> Barbara makes a wish</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap for 2021</a></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="barbara-wants-to-use-ghostcell-like-cell-borrowing-with-futures"><a class="header" href="#barbara-wants-to-use-ghostcell-like-cell-borrowing-with-futures">Barbara wants to use GhostCell-like cell borrowing with futures</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the
brainstorming period. It is derived from real-life experiences of
actual Rust users and is meant to reflect some of the challenges that
Async Rust programmers face today.</p>
<p>If you would like to expand on this story, or adjust the answers to
the FAQ, feel free to open a PR making edits (but keep in mind that,
as they reflect peoples' experiences, status quo stories <a href="../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be
wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../how_to_vision/status_quo.html">add your own
status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p>Barbara quite likes using statically-checked cell borrowing.  &quot;Cell&quot;
in Rust terminology refers to types like <code>Cell</code> or <code>RefCell</code> that
enable interior mutability, i.e. modifying or mutably borrowing stuff
even if you've only got an immutable reference to it.
Statically-checked cell borrowing is a technique whereby one object
(an &quot;owner&quot;) acts as a gatekeeper for borrow-access to a set of other
objects (&quot;cells&quot;).  So if you have mutable borrow access to the owner,
you can temporarily transfer that mutable borrow access to a cell in
order to modify it.  This is all checked at compile-time, hence
&quot;statically-checked&quot;.</p>
<p>In comparison <code>RefCell</code> does borrow-checking, but it is checked at
runtime and it will panic if you make a coding mistake.  The advantage
of statically-checked borrowing is that it cannot panic at runtime,
i.e. all your borrowing bugs show up at compile time.  The history
goes way back, and the technique has been reinvented at least 2-3
times as far as Barbara is aware.  This is implemented in various
forms in <a href="http://plv.mpi-sws.org/rustbelt/ghostcell/">GhostCell</a> and
<a href="https://docs.rs/qcell/0.4.1/qcell/"><code>qcell</code></a>.</p>
<p>Barbara would like to use statically-checked cell borrowing within
futures, but there is no way to get the owner borrow through the
<code>Future::poll</code> call, i.e. there is no argument or object that the
runtime could save the borrow in.  Mostly this does not cause a
problem, because there are other ways for a runtime to share data,
e.g. data can be incorporated into the future when it is created.
However in this specific case, for the specific technique of
statically-checked cell borrows, we need an active borrow to the owner
to be passed down the call stack through all the poll calls.</p>
<p>So Barbara is forced to use <code>RefCell</code> instead and be very careful not
to cause panics.  This seems like a step back.  It feels dangerous to
use <code>RefCell</code> and to have to manually verify that her cell borrows are
panic-free.</p>
<p>There are good habits that you can adopt to offset the dangers, of
course.  If you are very careful to make sure that you call no other
method or function which might in turn call code which might attempt
to get another borrow on the same cell, then the <code>RefCell::borrow_mut</code>
panics can be avoided.  However this is easy to overlook, and it is
easy to fail to anticipate what indirect calls will be made by a given
call, and of course this may change later on due to maintenance and
new features.  A borrow may stay active longer than expected, so calls
which appear safe might actually panic.  Sometimes it's necessary to
manually drop the borrow to be sure.  In addition you'll never know
what indirect calls might be made until all the possible code-paths
have been explored, either through testing or through running in
production.</p>
<p>So Barbara prefers to avoid all these problems, and use
statically-checked cell borrowing where possible.</p>
<h3 id="example-1-accessing-an-object-shared-outside-the-runtime"><a class="header" href="#example-1-accessing-an-object-shared-outside-the-runtime">Example 1: Accessing an object shared outside the runtime</a></h3>
<p>In this minimized example of code to interface a stream to code
outside of the async/await system, the buffer has to be accessible
from both the stream and the outside code, so it is handled as a
<code>Rc&lt;RefCell&lt;StreamBuffer&lt;T&gt;&gt;&gt;</code>.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct StreamPipe&lt;T&gt; {
    buf: Rc&lt;RefCell&lt;StreamBuffer&lt;T&gt;&gt;&gt;,
    req_more: Rc&lt;dyn Fn()&gt;,
}

impl&lt;T&gt; Stream for StreamPipe&lt;T&gt; {
    type Item = T;

    fn poll_next(self: Pin&lt;&amp;mut Self&gt;, _: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Option&lt;T&gt;&gt; {
        let mut buf = self.buf.borrow_mut();
        if let Some(item) = buf.value.take() {
            return Poll::Ready(Some(item));
        }
        if buf.end {
            return Poll::Ready(None);
        }
        (self.req_more)();  // Callback to request more data
        Poll::Pending
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Probably <code>req_more()</code> has to schedule some background operation, but
if it doesn't and attempts to modify the shared <code>buf</code> immediately then
we get a panic, because <code>buf</code> is still borrowed.  The real life code
could be a lot more complicated, and the required combination of
conditions might be harder to hit in testing.</p>
<p>With statically-checked borrowing, the borrow would be something like
<code>let mut buf = self.buf.rw(cx);</code>, and the <code>req_more</code> call would either
have to take the <code>cx</code> as an argument (forcing the previous borrow to
end) or would not take <code>cx</code>, meaning that it would always have to
defer the access to the buffer to other code, because without the <code>cx</code>
there is no possible way to access the buffer.</p>
<h3 id="example-2-shared-monitoring-data"><a class="header" href="#example-2-shared-monitoring-data">Example 2: Shared monitoring data</a></h3>
<p>In this example, the app keeps tallies of various things in a
<code>Monitor</code> structure.  This might be data in/out, number of errors
detected, maybe a hashmap of current links, etc.  Since it is accessed
from various components, it is kept behind an <code>Rc&lt;RefCell&lt;_&gt;&gt;</code>.</p>
<pre><pre class="playground"><code class="language-rust edition2018">// Dependency: futures-lite = &quot;1.11.3&quot;
use std::cell::RefCell;
use std::rc::Rc;

fn main() {
    let monitor0 = Rc::new(RefCell::new(Monitor { count: 0 }));
    let monitor1 = monitor0.clone();

    let fut0 = async move {
        let mut borrow = monitor0.borrow_mut();
        borrow.count += 1;
    };

    let fut1 = async move {
        let mut borrow = monitor1.borrow_mut();
        borrow.count += 1;
        fut0.await;
    };

    futures_lite::future::block_on(fut1);
}

struct Monitor {
    count: usize,
}
</code></pre></pre>
<p>The problem is that this panics with a borrowing error because the
borrow is still active when the <code>fut0.await</code> executes and attempts
another borrow.  The solution is to remember to drop the borrow before
awaiting.</p>
<p>In this example code the bug is obvious, but in real life maybe <code>fut0</code>
only borrows in rare situations, e.g. when an error is detected.  Or
maybe the future that borrows is several calls away down the
callstack.</p>
<p>With statically-checked borrowing, there is a slight problem in that
currently there is no way to access the poll context from <code>async {}</code>
code.  But if there was then the borrow would be something like <code>let mut borrow = monitor1.rw(cx);</code>, and since the <code>fut0.await</code> implicitly
requires the <code>cx</code> in order to poll, the borrow would be forced to end
at that point.</p>
<h2 id="further-investigation-by-barbara"><a class="header" href="#further-investigation-by-barbara">Further investigation by Barbara</a></h2>
<h3 id="the-mechanism"><a class="header" href="#the-mechanism">The mechanism</a></h3>
<p>Barbara understands that statically-checked cell borrows work by
having an owner held by the runtime, and various instances of a cell
held by things running on top of the runtime (these cells would
typically be behind <code>Rc</code> references).  A mutable borrow on the owner
is passed down the stack, which enables safe borrows on all the cells,
since a mutable borrow on a cell is enabled by temporarily holding
onto the mutable borrow of the owner, which is all checked at
compile-time.</p>
<p>So the mutable owner borrow needs to be passed through the <code>poll</code>
call, and Barbara realizes that this would require support from the
standard library.</p>
<p>Right now a <code>&amp;mut Context&lt;'_&gt;</code> is passed to <code>poll</code>, and so within
<code>Context</code> would be the ideal place to hold a borrow on the cell owner.
However as far as Barbara can see there are difficulties with all the
current implementations:</p>
<ul>
<li>
<p>GhostCell (or qcell::LCell) may be the best available solution,
because it doesn't have any restrictions on how many runtimes might
be running or how they might be nested.  But Rust insists that the
lifetimes <code>&lt;'id&gt;</code> on methods and types are explicit, so it seems
like that would force a change to the signature of <code>poll</code>, which
would break the ecosystem.</p>
<p>Here Barbara experiments with a working example of a modified Future
trait and a future implementation that makes use of LCell:</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2018">// Requires dependency: qcell = &quot;0.4&quot;
use qcell::{LCell, LCellOwner};
use std::pin::Pin;
use std::rc::Rc;
use std::task::Poll;

struct Context&lt;'id, 'a&gt; {
    cell_owner: &amp;'a mut LCellOwner&lt;'id&gt;,
}

struct AsyncCell&lt;'id, T&gt;(LCell&lt;'id, T&gt;);
impl&lt;'id, T&gt; AsyncCell&lt;'id, T&gt; {
    pub fn new(value: T) -&gt; Self {
        Self(LCell::new(value))
    }
    pub fn rw&lt;'a, 'b: 'a&gt;(&amp;'a self, cx: &amp;'a mut Context&lt;'id, 'b&gt;) -&gt; &amp;'a mut T {
        cx.cell_owner.rw(&amp;self.0)
    }
}

trait Future&lt;'id&gt; {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'id, '_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}

struct MyFuture&lt;'id&gt; {
    count: Rc&lt;AsyncCell&lt;'id, usize&gt;&gt;,
}
impl&lt;'id&gt; Future&lt;'id&gt; for MyFuture&lt;'id&gt; {
    type Output = ();
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'id, '_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        *self.count.rw(cx) += 1;
        Poll::Ready(())
    }
}

fn main() {
    LCellOwner::scope(|mut owner| {
        let mut cx = Context { cell_owner: &amp;mut owner };
        let count = Rc::new(AsyncCell::new(0_usize));
        let mut fut = Box::pin(MyFuture { count: count.clone() });
        let _ = fut.as_mut().poll(&amp;mut cx);
        assert_eq!(1, *count.rw(&amp;mut cx));
    });
}
</code></pre></pre>
<ul>
<li>
<p>The other <code>qcell</code> types (QCell, TCell and TLCell) have various
restrictions or overheads which might make them unsuitable as a
general-purpose solution in the standard library.  However they do
have the positive feature of not requiring any change in the
signature of <code>poll</code>.  It looks like they could be added to <code>Context</code>
without breaking anything.</p>
<p>Here Barbara tries using <code>TLCell</code>, and finds that the signature of
<code>poll</code> doesn't need to change:</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust edition2018">// Requires dependency: qcell = &quot;0.4&quot;
use qcell::{TLCell, TLCellOwner};
use std::pin::Pin;
use std::rc::Rc;
use std::task::Poll;

struct AsyncMarker;
struct Context&lt;'a&gt; {
    cell_owner: &amp;'a mut TLCellOwner&lt;AsyncMarker&gt;,
}

struct AsyncCell&lt;T&gt;(TLCell&lt;AsyncMarker, T&gt;);
impl&lt;T&gt; AsyncCell&lt;T&gt; {
    pub fn new(value: T) -&gt; Self {
        Self(TLCell::new(value))
    }
    pub fn rw&lt;'a, 'b: 'a&gt;(&amp;'a self, cx: &amp;'a mut Context&lt;'b&gt;) -&gt; &amp;'a mut T {
        cx.cell_owner.rw(&amp;self.0)
    }
}

trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt;;
}

struct MyFuture {
    count: Rc&lt;AsyncCell&lt;usize&gt;&gt;,
}
impl Future for MyFuture {
    type Output = ();
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
        *self.count.rw(cx) += 1;
        Poll::Ready(())
    }
}

fn main() {
    let mut owner = TLCellOwner::new();
    let mut cx = Context { cell_owner: &amp;mut owner };
    let count = Rc::new(AsyncCell::new(0_usize));
    let mut fut = Box::pin(MyFuture { count: count.clone() });
    let _ = fut.as_mut().poll(&amp;mut cx);
    assert_eq!(1, *count.rw(&amp;mut cx));
}
</code></pre></pre>
<p>(For comparison, <code>TCell</code> only allows one owner per marker type in
the whole process.  <code>QCell</code> allows many owners, but requires a
runtime check to make sure you're using the right owner to access a
cell.  <code>TLCell</code> allows only one owner per thread per marker type,
but also lets cells migrate between threads and be borrowed locally,
which the others don't -- see <a href="https://docs.rs/qcell/0.4.1/qcell/">qcell
docs</a>.)</p>
<p>So the choice is GhostCell/LCell and lifetimes everywhere, or various
other cell types that may be too restrictive.</p>
<p>Right now Barbara thinks that none of these solutions is likely to be
acceptable for the standard library.  However still it is a desirable
feature, so maybe someone can think of a way around the problems.  Or
maybe someone has a different perspective on what would be acceptable.</p>
<h3 id="proof-of-concept"><a class="header" href="#proof-of-concept">Proof of concept</a></h3>
<p>The <a href="https://crates.io/crates/stakker">Stakker</a> runtime makes use of
qcell-based statically-checked cell borrowing.  It uses this to get
zero-cost access to actors, guaranteeing at compile time that no actor
can access any other actor's state.  It also uses it to allow
inter-actor <a href="https://docs.rs/stakker/0.2.1/stakker/struct.Share.html">shared
state</a> to be
accessed safely and zero-cost, without RefCell.</p>
<p>(For example within a Stakker actor, you can access the contents of a
<code>Share&lt;T&gt;</code> via the actor context <code>cx</code> as follows: <code>share.rw(cx)</code>,
which blocks borrowing or accessing <code>cx</code> until that borrow on <code>share</code>
has been released.  <code>Share&lt;T&gt;</code> is effectively a <code>Rc&lt;ShareCell&lt;T&gt;</code> and
<code>cx</code> has access to an active borrow on the <code>ShareCellOwner</code>, just as
in the long examples above.)</p>
<p>Stakker doesn't use GhostCell (LCell) because of the need for <code>&lt;'id&gt;</code>
annotations on methods and types.  Instead it uses the other three
cell types according to how many Stakker instances will be run, either
one Stakker instance only, one per thread, or multiple per thread.
This is selected by cargo features.</p>
<p>Switching implementations like this doesn't seem like an option for
the standard library.</p>
<h3 id="way-forward"><a class="header" href="#way-forward">Way forward</a></h3>
<p>Barbara wonders whether there is any way this can be made to work.
For example, could the compiler derive all those <code>&lt;'id&gt;</code> annotations
automatically for GhostCell/LCell?</p>
<p>Or for multi-threaded runtimes, would
<a href="https://docs.rs/qcell/0.4.1/qcell/"><code>qcell::TLCell</code></a> be acceptable?
This allows a single cell-owner in every thread.  So it would not
allow nested runtimes of the same type.  However it does allow borrows
to happen at the same time independently in different threads, and it
also allows the migration of cells between threads, which is safe
because that kind of cell isn't <code>Sync</code>.</p>
<p>Or is there some other form of cell-borrowing that could be devised
that would work better for this?</p>
<p>The interface between cells and <code>Context</code> should be straightforward
once a particular cell type is demonstrated to be workable with the
<code>poll</code> interface and futures ecosystem.  For example copying the API
style of Stakker:</p>
<pre><code>let rc = Rc::new(AsyncCell::new(1_u32));
*rc.rw(cx) = 2;
</code></pre>
<p>So logically you obtain read-write access to a cell by naming the
authority by which you claim access, in this case the poll context.
In this case it really is naming rather than accessing since the
checks are done at compile time and the address that <code>cx</code> represents
doesn't actually get passed anywhere or evaluated, once inlining and
optimisation is complete.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<p>The main problem is that Barbara has got used to a safer environment
and it feels dangerous to go back to RefCell and have to manually
verify that her cell borrows are panic-free.</p>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<p>The author of Stakker is trying to interface it to async/await and
futures.</p>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story"><strong>Why did you choose Barbara to tell this story?</strong></a></h3>
<p>Barbara has enough Rust knowledge to understand the benefits that
GhostCell/qcell-like borrowing might bring.</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<p>The other characters perhaps wouldn't have heard of statically-checked
cell borrows so would be unaware of the possibility of making things
safer.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vision/status_quo/barbara_wants_async_insights.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vision/status_quo/grace_deploys_her_service.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vision/status_quo/barbara_wants_async_insights.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vision/status_quo/grace_deploys_her_service.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
