<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara carefully dismisses embedded Future - wg-async-foundations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/tenets.html"><strong aria-hidden="true">2.2.</strong> ‚úèÔ∏è Design tenets for async</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/template.html"><strong aria-hidden="true">2.5.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.5.2.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.5.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.5.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.5.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.5.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">2.5.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.5.8.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.5.9.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.5.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.5.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.5.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.5.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.5.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.5.15.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.5.16.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.5.17.</strong> Barbara Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.5.18.</strong> Barbara builds an async executor</a></li><li class="chapter-item expanded "><a href="../../vision/status_quo/barbara_carefully_dismisses_embedded_future.html" class="active"><strong aria-hidden="true">2.5.19.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.5.20.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.5.21.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.5.22.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_plays_with_async.html"><strong aria-hidden="true">2.5.23.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.5.24.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.5.25.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.5.26.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">2.5.27.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.5.28.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.5.29.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.5.30.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.5.31.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.5.32.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.5.33.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/template.html"><strong aria-hidden="true">2.6.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.6.2.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.6.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.6.4.</strong> Barbara makes a wish</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap for 2021</a></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-barbara-carefully-dismisses-embedded-future"><a class="header" href="#-status-quo-stories-barbara-carefully-dismisses-embedded-future">üò± Status quo stories: Barbara carefully dismisses embedded <code>Future</code></a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../how_to_vision/status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p><a href="../characters/barbara.html">Barbara</a> is contributing to an <a href="https://www.tockos.org">OS</a> that supports
running multiple applications on a single microcontroller. These
microcontrollers have as little as 10's of kilobytes of RAM and 100's of
kilobytes of flash memory for code. Barbara is writing a library that is used by
multiple applications -- and is linked into each application -- so the library
is very resource constrained. The library should support asynchronous operation,
so that multiple APIs can be used in parallel within each (single-threaded)
application.</p>
<p>Barbara begins writing the library by trying to write a console interface, which
allows byte sequences to be printed to the system console. Here is an example
sequence of events for a console print:</p>
<ol>
<li>The interface gives the kernel a callback to call when the print finishes,
and gives the kernel the buffer to print.</li>
<li>The kernel prints the buffer in the background while the app is free to do
other things.</li>
<li>The print finishes.</li>
<li>The app tells the kernel it is ready for the callback to be invoked, and the
kernel invokes the callback.</li>
</ol>
<p>Barbara tries to implement the API using
<a href="https://doc.rust-lang.org/stable/core/future/trait.Future.html"><code>core::future::Future</code></a>
so that the library can be compatible with the async Rust ecosystem. The OS
kernel does not expose a Future-based interface, so Barbara has to implement
<code>Future</code> by hand rather than using async/await syntax. She starts with a
skeleton:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Passes `buffer` to the kernel, and prints it to the console. Returns a
/// future that returns `buffer` when the print is complete. The caller must
/// call kernel_ready_for_callbacks() when it is ready for the future to return. 
fn print_buffer(buffer: &amp;'static mut [u8]) -&gt; PrintFuture {
    // TODO: Set the callback
    // TODO: Tell the kernel to print `buffer`
}

struct PrintFuture;

impl core::future::Future for PrintFuture {
    type Output = &amp;'static mut [u8];

    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context) -&gt; Poll&lt;Self::Output&gt; {
        // TODO: Detect when the print is done, retrieve `buffer`, and return
        // it.
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Note: All error handling is omitted to keep things understandable.</p>
<p>Barbara begins to implement <code>print_buffer</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn print_buffer(buffer: &amp;'static mut [u8]) -&gt; PrintFuture {
    kernel_set_print_callback(callback);
    kernel_start_print(buffer);
    PrintFuture {}
}

// New! The callback the kernel calls.
extern fn callback() {
    // TODO: Wake up the currently-waiting PrintFuture.
}
<span class="boring">}
</span></code></pre></pre>
<p>So far so good. Barbara then works on <code>poll</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context) -&gt; Poll&lt;Self::Output&gt; {
        if kernel_is_print_done() {
            return Poll::Ready(kernel_get_buffer_back());
        }
        Poll::Pending
    }
<span class="boring">}
</span></code></pre></pre>
<p>Of course, there's something missing here. How does the callback wake the
<code>PrintFuture</code>? She needs to store the
<a href="https://doc.rust-lang.org/stable/core/task/struct.Waker.html"><code>Waker</code></a>
somewhere! Barbara puts the <code>Waker</code> in a global variable so the callback can
find it (this is fine because the app is single threaded and callbacks do NOT
interrupt execution the way Unix signals do):</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static mut PRINT_WAKER: Option&lt;Waker&gt; = None;

extern fn callback() {
    if let Some(waker) = unsafe { PRINT_WAKER.as_ref() } {
        waker.wake_by_ref();
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>She then modifies <code>poll</code> to set <code>PRINT_WAKER</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context) -&gt; Poll&lt;Self::Output&gt; {
        if kernel_is_print_done() {
            return Poll::Ready(kernel_get_buffer_back());
        }
        unsafe { PRINT_WAKER = Some(cx.waker()); }
        Poll::Pending
    }
<span class="boring">}
</span></code></pre></pre>
<p><code>PRINT_WAKER</code> is stored in <code>.bss</code>, which occupies space in RAM but not flash. It
is two words in size. It points to a
<a href="https://doc.rust-lang.org/stable/core/task/struct.RawWakerVTable.html"><code>RawWakerVTable</code></a>
that is provided by the executor. <code>RawWakerVTable</code>'s design is a compromise that
supports environments both with and without <code>alloc</code>. In no-<code>alloc</code> environments,
<code>drop</code> and <code>clone</code> are generally no-ops, and <code>wake</code>/<code>wake_by_ref</code> seem like
duplicates. Looking at <code>RawWakerVTable</code> makes Barbara realize that even though
<code>Future</code> was designed to work in embedded contexts, it may have too much
overhead for her use case.</p>
<p>Barbara decides to do some benchmarking. She comes up with a sample application
-- an app that blinks a led and responds to button presses -- and implements it
twice. One implementation does not use <code>Future</code> at all, the other does. Both
implementations have two asynchronous interfaces: a timer interface and a GPIO
interface, as well as an application component that uses the interfaces
concurrently. In the <code>Future</code>-based app, the application component functions
like a future combinator, as it is a <code>Future</code> that is almost always waiting for
a timer or GPIO future to finish.</p>
<p>To drive the application future, Barbara implements an executor. The executor
functions like a background thread. Because <code>alloc</code> is not available, this
executor contains a single future. The executor has a <code>spawn</code> function that
accepts a future and starts running that future (overwriting the existing future
in the executor if one is already present). Once started, the executor runs
entirely in kernel callbacks.</p>
<p>Barbara identifies several factors that add branching and error handling code to
the executor:</p>
<ol>
<li><code>spawn</code> should be a safe function, because it is called by high-level
application code. However, that means it can be called by the future it
contains. If handled naively, this would result in dropping the future while
it executes. Barbara adds runtime checks to identify this situation.</li>
<li><code>Waker</code> is <code>Sync</code>, so on a multithreaded system, a future could give another
thread access to its <code>Waker</code> and the other thread could wake it up. This
could happen while the <code>poll</code> is executing, before <code>poll</code> returns
<code>Poll::Pending</code>. Therefore, Barbara concludes that if <code>wake</code> is called while
a future is being polled then the future should be re-polled, even if the
current <code>poll</code> returns <code>Poll::Pending</code>. This requires putting a retry loop
into the executor.</li>
<li>A kernel callback may call <code>Waker::wake</code> after its future returns
<code>Poll::Ready</code>. After <code>poll</code> returns <code>Poll::Ready</code>, the executor should not
<code>poll</code> the future again, so Barbara adds code to ignore those wakeups. This
duplicates the &quot;ignore spurious wakeups&quot; functionality that exists in the
future itself.</li>
</ol>
<p>Ultimately, this made the <a href="https://github.com/tock/design-explorations/blob/master/size_comparison/futures/src/task.rs">executor
logic</a>
nontrivial, and it compiled into 96 bytes of code. The executor logic is
monomorphized for each future, which allows the compiler to make inlining
optimizations, but results in a significant amount of duplicate code.
Alternatively, it could be adapted to use function pointers or vtables to avoid
the code duplication, but then the compiler <em>definitely</em> cannot inline
<code>Future::poll</code> into the kernel callbacks.</p>
<p>Barbara publishes an
<a href="https://github.com/tock/design-explorations/tree/master/size_comparison">analysis</a>
of the relative sizes of the two app implementations, finding a large percentage
increase in both code size and RAM usage (note: stack usage was not
investigated). Most of the code size increase is from the future
combinator code.</p>
<p>In the no-<code>Future</code> version of the app, a kernel callback causes the following:</p>
<ol>
<li>The kernel callback calls the application logic's event-handling function for
the specific event type.</li>
<li>The application handles the event.</li>
</ol>
<p>The call in step 1 is inlined, so the compiled kernel callback consists only of
the application's event-handling logic.</p>
<p>In the <code>Future</code>-based version of the app, a kernel callback causes the
following:</p>
<ol>
<li>The kernel callback updates some global state to indicate the event happened.</li>
<li>The kernel callback invokes <code>Waker::wake</code>.</li>
<li><code>Waker::wake</code> calls <code>poll</code> on the application future.</li>
<li>The application future has to look at the state saved in step 1 to determine
what event happened.</li>
<li>The application future handles the event.</li>
</ol>
<p>LLVM is unable to devirtualize the call in step 2, so the optimizer is unable to
simplify the above steps. Steps 1-4 only exist in the future-based version of
the code, and add over 200 bytes of code (note: Barbara believes this could be
reduced to between 100 and 200 bytes at the expense of execution speed).</p>
<p>Barbara concludes that <strong><code>Future</code> is not suitable for
highly-resource-constrained environments</strong> due to the amount of code and RAM
required to implement executors and combinators.</p>
<p>Barbara redesigns the library she is building to use a <a href="https://github.com/tock/design-explorations/tree/master/zst_pointer_async">different
concept</a>
for implementing async APIs in Rust that are much lighter weight. She has moved
on from <code>Future</code> and is refining her <a href="https://github.com/tock/libtock-rs/blob/master/core/platform/src/async_traits.rs">async
traits</a>
instead. Here are some ways in which these APIs are lighter weight than a
<code>Future</code> implementation:</p>
<ol>
<li>After monomorphization, kernel callbacks directly call application code. This
allows the application code to be inlined into the kernel callback.</li>
<li>The callback invocation is more precise: these APIs don't make spurious
wakeups, so application code does not need to handle spurious wakeups.</li>
<li>The async traits lack an equivalent of <code>Waker</code>. Instead, all callbacks are
expected to be <code>'static</code> (i.e. they modify global state) and passing pointers
around is replaced by static dispatch.</li>
</ol>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story">What are the morals of the story?</a></h3>
<ul>
<li><code>core::future::Future</code> isn't suitable for every asynchronous API in Rust.
<code>Future</code> has a lot of capabilities, such as the ability to spawn
dynamically-allocated futures, that are unnecessary in embedded systems.
These capabilities have a cost, which is unavoidable without
backwards-incompatible changes to the trait.</li>
<li>We should look at embedded Rust's relationship with <code>Future</code> so we don't
fragment the embedded Rust ecosystem. Other embedded crates use <code>Future</code>
-- <code>Future</code> certainly has a lot of advantages over lighter-weight
alternatives, if you have the space to use it.</li>
</ul>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story">Why did you choose <em>Barbara</em> to tell this story?</a></h3>
<ul>
<li>This story is about someone who is an experienced systems programmer and
an experienced Rust developer. All the other characters have &quot;new to Rust&quot;
or &quot;new to programming&quot; as a key characteristic.</li>
</ul>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters">How would this story have played out differently for the other characters?</a></h3>
<ul>
<li><a href="../characters/alan.html">Alan</a> would have found the <code>#![no_std]</code> crate ecosystem lacking async
support. He would have moved forward with a <code>Future</code>-based implementation,
unaware of its impact on code size and RAM usage.</li>
<li><a href="../characters/grace.html">Grace</a> would have handled the issue similarly to Barbara, but may not
have tried as hard to use <code>Future</code>. Barbara has been paying attention to
Rust long enough to know how significant the <code>Future</code> trait is in the Rust
community and ecosystem.</li>
<li><a href="../characters/niklaus.html">Niklaus</a> would really have struggled. If he asked for help, he probably
would've gotten conflicting advice from the community.</li>
</ul>
<h3 id="future-has-a-lot-of-features-that-barbaras-traits-dont-have----arent-those-worth-the-cost"><a class="header" href="#future-has-a-lot-of-features-that-barbaras-traits-dont-have----arent-those-worth-the-cost"><code>Future</code> has a lot of features that Barbara's traits don't have -- aren't those worth the cost?</a></h3>
<ul>
<li><code>Future</code> has many additional features that are nice-to-have:
<ol>
<li><code>Future</code> works smoothly in a multithreaded environment. Futures can
be <code>Send</code> and/or <code>Sync</code>, and do not need to have interior mutability,
which avoids the need for internal locking.
<ul>
<li>Manipulating arbitrary Rust types without locking allows <code>async fn</code>
to be efficient.</li>
</ul>
</li>
<li>Futures can be spawned and dropped in a dynamic manner: an executor
that supports dynamic allocation can manage an arbitrary number of
futures at runtime, and futures may easily be dropped to stop their
execution.
<ul>
<li>Dropping a future will also drop futures it owns, conveniently
providing good cancellation semantics.</li>
<li>A future that creates other futures (e.g. an <code>async fn</code> that calls
other <code>async fn</code>s) can be spawned with only a single memory
allocation, whereas callback-based approaches need to allocate for
each asynchronous component.</li>
</ul>
</li>
<li>Community and ecosystem support. This isn't a feature of <code>Future</code> per
se, but the Rust language has special support for <code>Future</code>
(<code>async</code>/<code>await</code>) and practically the entire async Rust ecosystem is
based on <code>Future</code>. The ability to use existing async crates is a very
strong reason to use <code>Future</code> over any alternative async abstraction.</li>
</ol>
</li>
<li>However, the code size impact of <code>Future</code> is a deal-breaker, and no number
of nice-to-have features can outweigh a deal-breaker. Barbara's traits
have every feature she <em>needs</em>.</li>
<li>Using <code>Future</code> saves developer time relative to building your own async
abstractions. Developers can use the time they saved to minimize code size
elsewhere in the project. In some cases, this may result in a net decrease
in code size for the same total effort. However, code size reduction
efforts have diminishing returns, so projects that expect to optimize code
size regardless likely won't find the tradeoff beneficial.</li>
</ul>
<h3 id="is-the-code-size-impact-of-future-fundamental-or-can-the-design-be-tweaked-in-a-way-that-eliminates-the-tradeoff"><a class="header" href="#is-the-code-size-impact-of-future-fundamental-or-can-the-design-be-tweaked-in-a-way-that-eliminates-the-tradeoff">Is the code size impact of <code>Future</code> fundamental, or can the design be tweaked in a way that eliminates the tradeoff?</a></h3>
<ul>
<li><code>Future</code> isolates the code that determines a future should wake up (the
code that calls <code>Waker::wake</code>) from the code that executes the future (the
executor). The only information transferred via <code>Waker::wake</code> is &quot;try
waking up now&quot; -- any other information has to be stored somewhere. When
polled, a future has to run logic to identify how it can make progress --
in many cases this requires answering &quot;who woke me up?&quot; -- and retrieve
the stored information. Most completion-driven async APIs allow
information about the event to be transferred directly to the code that
handles the event. According to Barbara's analysis, the code required to
determine what event happened was the majority of the size impact of
<code>Future</code>.</li>
</ul>
<h3 id="i-thought-future-was-a-zero-cost-abstraction"><a class="header" href="#i-thought-future-was-a-zero-cost-abstraction">I thought <code>Future</code> was a zero-cost abstraction?</a></h3>
<ul>
<li>Aaron Turon <a href="https://aturon.github.io/blog/2016/08/11/futures/#zero-cost">described futures as zero-cost
abstractions</a>.
In the linked post, he elaborated on what he meant by zero-cost
abstraction, and eliminating their impact on code size was not part of
that definition. Since then, the statement that future is a zero-cost
abstraction has been repeated many times, mostly without the context that
Aaron provided. Rust has many zero-cost abstractions, most of which do not
impact code size (assuming optimization is enabled), so it is easy for
developers to see &quot;futures are zero-cost&quot; and assume that makes them
lighter-weight than they are.</li>
</ul>
<h3 id="how-does-barbaras-code-handle-thread-safety-is-her-executor-unsound"><a class="header" href="#how-does-barbaras-code-handle-thread-safety-is-her-executor-unsound">How does Barbara's code handle thread-safety? Is her executor unsound?</a></h3>
<ul>
<li>The library Barbara is writing only works in Tock OS' userspace
environment. This environment is single-threaded: the runtime does not
provide a way to spawn another thread, hardware interrupts do not execute
in userspace, and there are no interrupt-style callbacks like Unix
signals. All kernel callbacks are invoked synchronously, using a method
that is functionally equivalent to a function call.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vision/status_quo/barbara_builds_an_async_executor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vision/status_quo/barbara_compares_some_cpp_code.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vision/status_quo/barbara_builds_an_async_executor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vision/status_quo/barbara_compares_some_cpp_code.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
