<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Barbara plays with async - wg-async-foundations</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../welcome.html"><strong aria-hidden="true">1.</strong> üëãüèΩ Welcome</a></li><li class="chapter-item expanded "><a href="../../vision.html"><strong aria-hidden="true">2.</strong> üîÆ The vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision.html"><strong aria-hidden="true">2.1.</strong> ‚ùìHow to vision</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/how_to_vision/projects.html"><strong aria-hidden="true">2.1.1.</strong> Projects</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/status_quo.html"><strong aria-hidden="true">2.1.2.</strong> &quot;Status quo&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/shiny_future.html"><strong aria-hidden="true">2.1.3.</strong> &quot;Shiny future&quot; stories</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/comment.html"><strong aria-hidden="true">2.1.4.</strong> Commenting</a></li><li class="chapter-item "><a href="../../vision/how_to_vision/awards.html"><strong aria-hidden="true">2.1.5.</strong> Awards</a></li></ol></li><li class="chapter-item "><a href="../../vision/tenets.html"><strong aria-hidden="true">2.2.</strong> ‚úèÔ∏è Design tenets for async</a></li><li class="chapter-item "><a href="../../vision/characters.html"><strong aria-hidden="true">2.3.</strong> üôã‚Äç‚ôÄÔ∏è Cast of characters</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/characters/alan.html"><strong aria-hidden="true">2.3.1.</strong> Alan</a></li><li class="chapter-item "><a href="../../vision/characters/grace.html"><strong aria-hidden="true">2.3.2.</strong> Grace</a></li><li class="chapter-item "><a href="../../vision/characters/niklaus.html"><strong aria-hidden="true">2.3.3.</strong> Niklaus</a></li><li class="chapter-item "><a href="../../vision/characters/barbara.html"><strong aria-hidden="true">2.3.4.</strong> Barbara</a></li></ol></li><li class="chapter-item "><a href="../../vision/projects.html"><strong aria-hidden="true">2.4.</strong> ‚ö° Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/projects/template.html"><strong aria-hidden="true">2.4.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/projects/MonsterMesh.html"><strong aria-hidden="true">2.4.2.</strong> MonsterMesh (embedded sensors)</a></li><li class="chapter-item "><a href="../../vision/projects/DistriData.html"><strong aria-hidden="true">2.4.3.</strong> DistriData (Generic Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/TrafficMonitor.html"><strong aria-hidden="true">2.4.4.</strong> TrafficMonitor (Custom Infrastructure)</a></li><li class="chapter-item "><a href="../../vision/projects/YouBuy.html"><strong aria-hidden="true">2.4.5.</strong> YouBuy (Traditional Server Application)</a></li><li class="chapter-item "><a href="../../vision/projects/SLOW.html"><strong aria-hidden="true">2.4.6.</strong> SLOW (Protocol implementation)</a></li></ol></li><li class="chapter-item expanded "><a href="../../vision/status_quo.html"><strong aria-hidden="true">2.5.</strong> üò± Status quo</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/status_quo/template.html"><strong aria-hidden="true">2.5.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_builds_a_cache.html"><strong aria-hidden="true">2.5.2.</strong> Alan tries to cache requests, which doesn't always happen</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_finds_database_drops_hard.html"><strong aria-hidden="true">2.5.3.</strong> Alan finds dropping database handles is hard</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_has_an_event_loop.html"><strong aria-hidden="true">2.5.4.</strong> Alan has an external event loop</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_hates_writing_a_stream.html"><strong aria-hidden="true">2.5.5.</strong> Alan hates writing a Stream</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_iteratively_regresses.html"><strong aria-hidden="true">2.5.6.</strong> Alan iteratively regresses performance</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_lost_the_world.html"><strong aria-hidden="true">2.5.7.</strong> Alan lost the world</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_needs_async_in_traits.html"><strong aria-hidden="true">2.5.8.</strong> Alan needs async in traits</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_picks_web_server.html"><strong aria-hidden="true">2.5.9.</strong> Alan wants to migrate a web server to Rust</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_runs_into_stack_trouble.html"><strong aria-hidden="true">2.5.10.</strong> Alan runs into stack trouble</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_started_trusting_the_rust_compiler_but_then_async.html"><strong aria-hidden="true">2.5.11.</strong> Alan started trusting the Rust compiler, but then... async</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_thinks_he_needs_async_locks.html"><strong aria-hidden="true">2.5.12.</strong> Alan thinks he needs async locks</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_a_socket_sink.html"><strong aria-hidden="true">2.5.13.</strong> Alan tries using a socket Sink</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_tries_to_debug_a_hang.html"><strong aria-hidden="true">2.5.14.</strong> Alan tries to debug a hang</a></li><li class="chapter-item "><a href="../../vision/status_quo/alan_writes_a_web_framework.html"><strong aria-hidden="true">2.5.15.</strong> Alan writes a web framework</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_anguishes_over_http.html"><strong aria-hidden="true">2.5.16.</strong> Barbara anguishes over HTTP</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_bridges_sync_and_async.html"><strong aria-hidden="true">2.5.17.</strong> Barbara Barbara bridges sync and async in perf.rust-lang.org</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_builds_an_async_executor.html"><strong aria-hidden="true">2.5.18.</strong> Barbara builds an async executor</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_carefully_dismisses_embedded_future.html"><strong aria-hidden="true">2.5.19.</strong> Barbara carefully dismisses embedded Future</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_compares_some_cpp_code.html"><strong aria-hidden="true">2.5.20.</strong> Barbara compares some C++ code</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_makes_their_first_steps_into_async.html"><strong aria-hidden="true">2.5.21.</strong> Barbara makes their first foray into async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_needs_async_helpers.html"><strong aria-hidden="true">2.5.22.</strong> Barbara needs Async Helpers</a></li><li class="chapter-item expanded "><a href="../../vision/status_quo/barbara_plays_with_async.html" class="active"><strong aria-hidden="true">2.5.23.</strong> Barbara plays with async</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_tries_async_streams.html"><strong aria-hidden="true">2.5.24.</strong> Barbara tries async streams</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_trims_a_stacktrace.html"><strong aria-hidden="true">2.5.25.</strong> Barbara trims a stacktrace</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_async_insights.html"><strong aria-hidden="true">2.5.26.</strong> Barbara wants async insights</a></li><li class="chapter-item "><a href="../../vision/status_quo/barbara_wants_to_use_ghostcell.html"><strong aria-hidden="true">2.5.27.</strong> Barbara wants to use GhostCell-like cell borrowing</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_deploys_her_service.html"><strong aria-hidden="true">2.5.28.</strong> Grace deploys her service and hits obstacles</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_tries_new_libraries.html"><strong aria-hidden="true">2.5.29.</strong> Grace tries new libraries</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_waits_for_gdb_next.html"><strong aria-hidden="true">2.5.30.</strong> Grace waits for gdb next</a></li><li class="chapter-item "><a href="../../vision/status_quo/grace_wants_to_integrate_c_api.html"><strong aria-hidden="true">2.5.31.</strong> Grace wants to integrate a C-API</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_simulates_hydrodynamics.html"><strong aria-hidden="true">2.5.32.</strong> Niklaus builds a hydrodynamics simulator</a></li><li class="chapter-item "><a href="../../vision/status_quo/niklaus_wants_to_share_knowledge.html"><strong aria-hidden="true">2.5.33.</strong> Niklaus wants to share knowledge</a></li></ol></li><li class="chapter-item "><a href="../../vision/shiny_future.html"><strong aria-hidden="true">2.6.</strong> ‚ú® Shiny future</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../vision/shiny_future/template.html"><strong aria-hidden="true">2.6.1.</strong> Template</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alan_switches_runtimes.html"><strong aria-hidden="true">2.6.2.</strong> Alan switches runtimes</a></li><li class="chapter-item "><a href="../../vision/shiny_future/alans_trust_in_the_compiler_is_rewarded.html"><strong aria-hidden="true">2.6.3.</strong> Alan's trust in the compiler is rewarded</a></li><li class="chapter-item "><a href="../../vision/shiny_future/barbara_makes_a_wish.html"><strong aria-hidden="true">2.6.4.</strong> Barbara makes a wish</a></li></ol></li><li class="chapter-item "><a href="../../vision/roadmap.html"><strong aria-hidden="true">2.7.</strong> üìÖ Roadmap for 2021</a></li></ol></li><li class="chapter-item "><a href="../../triage.html"><strong aria-hidden="true">3.</strong> üîç Triage meetings</a></li><li class="chapter-item "><a href="../../design_docs.html"><strong aria-hidden="true">4.</strong> üî¨ Design docs</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/yield_safe.html"><strong aria-hidden="true">4.1.</strong> ‚ö†Ô∏è Yield-safe lint</a></li><li class="chapter-item "><a href="../../design_docs/stream.html"><strong aria-hidden="true">4.2.</strong> ‚òî Stream trait</a></li><li class="chapter-item "><a href="../../design_docs/generator_syntax.html"><strong aria-hidden="true">4.3.</strong> ‚ö° Generator syntax</a></li><li class="chapter-item "><a href="../../design_docs/async_read_write.html"><strong aria-hidden="true">4.4.</strong> üìù AsyncRead, AsyncWrite traits</a></li><li class="chapter-item "><a href="../../design_docs/async_fn_in_traits.html"><strong aria-hidden="true">4.5.</strong> üß¨ Async fn in traits</a></li><li class="chapter-item "><a href="../../design_docs/mutex.html"><strong aria-hidden="true">4.6.</strong> üîí Mutex (future-aware)</a></li><li class="chapter-item "><a href="../../design_docs/channels.html"><strong aria-hidden="true">4.7.</strong> üì∫ Async aware channels</a></li><li class="chapter-item "><a href="../../design_docs/async_closures.html"><strong aria-hidden="true">4.8.</strong> üì¶ Async closures</a></li><li class="chapter-item "><a href="../../design_docs/join.html"><strong aria-hidden="true">4.9.</strong> ü§ù Join combinator</a></li><li class="chapter-item "><a href="../../design_docs/select.html"><strong aria-hidden="true">4.10.</strong> ü§∑‚Äç‚ôÄÔ∏è Select combinator</a></li><li class="chapter-item "><a href="../../design_docs/sink_trait.html"><strong aria-hidden="true">4.11.</strong> üö∞ Sink trait</a></li><li class="chapter-item "><a href="../../design_docs/async_main.html"><strong aria-hidden="true">4.12.</strong> üéá Async main</a></li><li class="chapter-item "><a href="../../design_docs/async_drop.html"><strong aria-hidden="true">4.13.</strong> üóëÔ∏è Async drop</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../design_docs/async_lifecycle.html"><strong aria-hidden="true">4.13.1.</strong> ‚ôªÔ∏è Async lifecycle</a></li></ol></li><li class="chapter-item "><a href="../../design_docs/completion_based_futures.html"><strong aria-hidden="true">4.14.</strong> ‚è≥ Completion-based futures</a></li></ol></li><li class="chapter-item "><a href="../../conversations.html"><strong aria-hidden="true">5.</strong> üí¨ Conversations</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../conversations/2021-02-12-Twitter-Thread.html"><strong aria-hidden="true">5.1.</strong> üê¶ 2021-02-12 Twitter thread</a></li></ol></li><li class="chapter-item "><a href="../../acknowledgments.html"><strong aria-hidden="true">6.</strong> ‚ù§Ô∏è Acknowledgments</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">wg-async-foundations</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/rust-lang/wg-async-foundations" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-status-quo-stories-barbara-plays-with-async"><a class="header" href="#-status-quo-stories-barbara-plays-with-async">üò± Status quo stories: Barbara plays with async</a></h1>
<h2 id="-warning-draft-status-"><a class="header" href="#-warning-draft-status-">üöß Warning: Draft status üöß</a></h2>
<p>This is a draft &quot;status quo&quot; story submitted as part of the brainstorming period. It is derived from real-life experiences of actual Rust users and is meant to reflect some of the challenges that Async Rust programmers face today. </p>
<p>If you would like to expand on this story, or adjust the answers to the FAQ, feel free to open a PR making edits (but keep in mind that, as they reflect peoples' experiences, status quo stories <a href="../how_to_vision/comment.html#comment-to-understand-or-improve-not-to-negate-or-dissuade">cannot be wrong</a>, only inaccurate). Alternatively, you may wish to <a href="../how_to_vision/status_quo.html">add your own status quo story</a>!</p>
<h2 id="the-story"><a class="header" href="#the-story">The story</a></h2>
<p><a href="../characters/barbara.html">Barbara</a> has been following async rust for a long time, in eager anticipation
of writing some project using async.  The last time she tried to do anything
with futures in rust was more than a year ago (before async functions), and
when you had to chain futures together with many calls to <code>then</code>
(often leading to inscrutable error messages hundreds of characters long).
This was not a pleasant experience for Barbara.</p>
<p>After watching the development of rust async/await (by following
discussions on <a href="https://www.reddit.com/r/rust">/r/rust</a> and the <a href="https://internals.rust-lang.org/">internals</a> forums), she wants
to start to play around with writing async code.  Before starting on any real
project, she starts with a &quot;playground&quot; where she can try to write some simple
async rust code to see how it feels and how it compares to how async code feels
in other languages she knows (like C# and JavaScript).</p>
<p>She starts by opening a blank project in VSCode with <a href="https://rust-analyzer.github.io/">rust-analyzer</a>.  Because she's
been following the overall state of rust async, she knows that she needs a runtime,
and quickly decides to use tokio, because she knows its quite popular and well documented.</p>
<p>After looking the long length of the <a href="https://tokio.rs/tokio/tutorial">tokio tutorial</a>, she decides to not read
most of it right now, and tries to dive right in to writing code.  But she does
look at the &quot;<a href="https://tokio.rs/tokio/tutorial/hello-tokio">Hello Tokio</a>&quot; section that shows what feature flags are required by tokio:</p>
<pre><code class="language-toml">[dependencies]
tokio = { version = &quot;1&quot;, features = [&quot;full&quot;] }
</code></pre>
<p>Poking around the tokio API docs in search of something to play with, she sees
a simple future that looks interesting: the <a href="https://docs.rs/tokio/1.4.0/tokio/time/fn.sleep.html"><code>sleep</code></a> future
that will wait for a certain duration to elapse before resolving.</p>
<p>Borrowing again from the &quot;Hello Tokio&quot; tutorial to make sure she has the correct
spelling for the tokio macros, she writes up the following code:</p>
<pre><pre class="playground"><code class="language-rust edition2018">#[tokio::main]
pub async fn main() {
    let mut rng = thread_rng();
    let t = Uniform::new(100, 5000);

    let mut futures = Vec::new();
    for _ in 0..10 {
        let delay = rng.sample(t);
        futures.push(tokio::time::sleep(Duration::from_millis(delay)));
    }
    println!(&quot;Created 10 futures&quot;);

    for f in futures {
        f.await;
    }

    println!(&quot;Done waiting for all futures&quot;);
}
</code></pre></pre>
<p>This very first version she wrote compiled on the first try and had no errors
when running it.  Barbara was pleased about this.</p>
<p>However, this example is pretty boring.  The program just sits there for a few
seconds doing nothing, and giving no hints about what it's actually doing.
So for the next iteration, Barbara wants to have a message printed out
when each future is resolved.  She tries this code at first:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut futures = Vec::new();
for _ in 0..10 {
    let delay = rng.sample(t);
    futures.push(tokio::time::sleep(Duration::from_millis(delay)).then(|_| {
        println!(&quot;Done!&quot;);
    }));
}
println!(&quot;Created 10 futures&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>But the compiler gives this error:</p>
<pre><code class="language-ignore">error[E0277]: `()` is not a future
  --&gt; src\main.rs:13:71
   |
13 |         futures.push(tokio::time::sleep(Duration::from_millis(delay)).then(|_| {
   |                                                                       ^^^^ `()` is not a future
   |
   = help: the trait `futures::Future` is not implemented for `()`
</code></pre>
<p>Even though the error is pointing at the <code>then</code> function, Barbara pretty quickly
recognizes the problem -- her closure needs to return a future, but <code>()</code> is not
a future (though she wonders &quot;why not?&quot;).  Looking at the tokio docs is not very
helpful.  The <code>Future</code> trait isn't even defined in the tokio docs, so
she looks at the docs for the Future trait in the rust standard library docs
and she sees it only has 5 implementors; one of them is called <code>Ready</code>
which looks interesting.
Indeed, this struct is a future that will resolve instantly, which is what
she wants:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>for _ in 0..10 {
    let delay = rng.sample(t);
    futures.push(tokio::time::sleep(Duration::from_millis(delay)).then(|_| {
        println!(&quot;Done!&quot;);
        std::future::ready(())
    }));
}
<span class="boring">}
</span></code></pre></pre>
<p>This compiles without error, but when Barbara goes to run the code, the output
surprises her a little bit:  After waiting running the program, nothing happened
for about 4 seconds.  Then the first &quot;Done!&quot; message was printed, followed very
quickly by the other 9 messages.   Based on the code she wrote, she expected 10
&quot;Done!&quot; messages to be printed to the console over the span of about 5 seconds,
with roughly a uniform distribution.</p>
<p>After running the program few more times, she always observes that while the
first view messages are printed after some delay, the last few messages are
always printed all at once.</p>
<p>Barbara has experience writing async code in JavaScript, and so she thinks for
a moment about how this toy code might have looked like if she was using JS:</p>
<pre><code class="language-javascript ignore">async function main() {
    const futures = [];
    for (let idx = 0; idx &lt; 10; idx++) {
        const delay = 100 + (Math.random() * 4900);
        const f = new Promise(() =&gt; {
            setTimeout(() =&gt; console.log(&quot;Done!&quot;), delay)
        })
        futures.push(f);
    }

    Promise.all(futures);
}
</code></pre>
<p>After imagining this code, Barbara has an &quot;ah-ha!&quot; moment, and realizes the
problem is likely how she is waiting for the futures in her rust code.
In her rust code, she is waiting for the futures one-by-one, but in the
JavaScript code she is waiting for all of them simultaneously.</p>
<p>So Barbara looks for a way to wait for a Vec of futures.  After a bunch of
searching in the tokio docs, she finds nothing.  The closet thing she finds
is a <code>join!</code> macro, but this appears to only work on individually specified
futures, not a Vec of futures.</p>
<p>Disappointed, she then looks at the <a href="https://doc.rust-lang.org/nightly/std/future/index.html">future module</a> from the rust standard
library, but module is tiny and very
clearly doesn't have what she wants.  Then Barbara has another &quot;ah-ha!&quot; moment
and remembers that there's a 3rd-party crate called &quot;<a href="https://crates.io/crates/futures">futures</a>&quot;
on crates.io that she's seen mentioned in some /r/rust posts.  She checks the
docs and finds the <code>join_all</code> function which looks like what she wants:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut futures = Vec::new();
for _ in 0..10 {
    let delay = rng.sample(t);
    futures.push(tokio::time::sleep(Duration::from_millis(delay)).then(|_| {
        println!(&quot;Done!&quot;);
        std::future::ready(())
    }));
}
println!(&quot;Created 10 futures&quot;);

futures::future::join_all(futures).await;
println!(&quot;Done&quot;);
<span class="boring">}
</span></code></pre></pre>
<p>It works exactly as expected now!  After having written the code, Barbara begins
to remember an important detail about rust futures that she once read somewhere:
rust futures are lazy, and won't make progress unless you await them.</p>
<p>Happy with this success, Barbara continues to expand her toy program by making
a few small adjustments:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>for counter in 0..10 {
    let delay = rng.sample(t);
    let delay_future = tokio::time::sleep(Duration::from_millis(delay));

    if counter &lt; 9 {
        futures.push(delay_future.then(|_| {
            println!(&quot;Done!&quot;);
            std::future::ready(())
        }));
    } else {
        futures.push(delay_future.then(|_| {
            println!(&quot;Done with the last future!&quot;);
            std::future::ready(())
        }));
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>This fails to compile:</p>
<pre><code class="language-ignore">error[E0308]: mismatched types

   = note: expected closure `[closure@src\main.rs:16:44: 19:14]`
              found closure `[closure@src\main.rs:21:44: 24:14]`
   = note: no two closures, even if identical, have the same type
   = help: consider boxing your closure and/or using it as a trait object
</code></pre>
<p>This error doesn't actually surprise Barbara that much, as she is familiar with
the idea of having to box objects sometimes.  She does
notice the &quot;consider boxing your closure&quot; error, but thinks that this is not
likely the correct solution.  Instead, she thinks that she should box the
entire future.</p>
<p>She first adds explicit type annotations to the Vec:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut futures: Vec&lt;Box&lt;dyn Future&lt;Output=()&gt;&gt;&gt; = Vec::new();
<span class="boring">}
</span></code></pre></pre>
<p>She then notices that her IDE (VSCode + rust-analyzer) has a new error on
each call to push.  The code assist on each error says <code>Store this in the heap by calling 'Box::new'</code>.  She is exactly what she wants, and it happy that
rust-analyzer perfectly handled this case.</p>
<p>Now each future is boxed up, but there is one final error still,
this time on the call to <code>join_all(futures).await</code>:</p>
<pre><code class="language-ignore">error[E0277]: `dyn futures::Future&lt;Output = ()&gt;` cannot be unpinned
  --&gt; src\main.rs:34:31
   |
34 |     futures::future::join_all(futures).await;
</code></pre>
<p>Barbara has been around rust for long enough to know that there is a <code>Box::pin</code>
API, but she doesn't really understand what it does, nor does she have a good
intuition about what this API is for.  But she is accustomed to just trying
things in rust to see if they work.  And indeed, after changing <code>Box::new</code> to
<code>Box::pin</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>futures.push(Box::pin(delay_future.then(|_| {
    println!(&quot;Done!&quot;);
    std::future::ready(())
})));
<span class="boring">}
</span></code></pre></pre>
<p>and adjusting the type of the Vec:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut futures: Vec&lt;Pin&lt;Box&lt;dyn Future&lt;Output=()&gt;&gt;&gt;&gt; = Vec::new();
<span class="boring">}
</span></code></pre></pre>
<p>the code compiles and runs successfully.</p>
<p>But even though the run is working correctly, she wishes she had a better idea
why pinning is necessary here and feels a little uneasy having to use something
she doesn't yet understand well.</p>
<p>As one final task, Barbara wants to try to replace the chained call to <code>then</code>
with a async block.  She remembers that these were a big deal in a recent
release of rust, and that they looked a lot nicer than a long chain of <code>then</code>
calls.  She doesn't remember the exact syntax for this, but she read a blog
post about async rust a few weeks ago, and has a vague idea of how it looks.</p>
<p>She tries writing this:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>futures.push(Box::pin(async || {
    tokio::time::sleep(Duration::from_millis(delay)).await;
    println!(&quot;Done after {}ms&quot;, delay);
}));
<span class="boring">}
</span></code></pre></pre>
<p>The compiler gives an error:</p>
<pre><code class="language-ignore">error[E0658]: async closures are unstable
  --&gt; src\main.rs:14:31
   |
14 |         futures.push(Box::pin(async || {
   |                               ^^^^^
   |
   = note: see issue #62290 &lt;https://github.com/rust-lang/rust/issues/62290&gt; for more information
   = help: add `#![feature(async_closure)]` to the crate attributes to enable
   = help: to use an async block, remove the `||`: `async {`
</code></pre>
<p>Barbara knows that async is stable and using this nightly feature isn't what
she wants.  So the tries the suggestion made by the compiler and removes the <code>||</code> bars:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>futures.push(Box::pin(async {
    tokio::time::sleep(Duration::from_millis(delay)).await;
    println!(&quot;Done after {}ms&quot;, delay);
}));
<span class="boring">}
</span></code></pre></pre>
<p>A new error this time:</p>
<pre><code class="language-ignore">error[E0597]: `delay` does not live long enough
15 | |             tokio::time::sleep(Duration::from_millis(delay)).await;
   | |                                                      ^^^^^ borrowed value does not live long enough
</code></pre>
<p>This is an error that Barbara is very familiar with.  If she was working with
a closure, she knows she can use a move-closure (since her <code>delay</code> type is <code>Copy</code>).
But she not using a closure (she just tried, but the compiler told her to switch
to an async block), but Barbara's experience with rust tells her that it's a very
consistent language.  Maybe the same keyword used in move closures will work here?
She tries it:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>futures.push(Box::pin(async move {
    tokio::time::sleep(Duration::from_millis(delay)).await;
    println!(&quot;Done after {}ms&quot;, delay);
}));
<span class="boring">}
</span></code></pre></pre>
<p>It works!  Satisfied but still thinking about async rust, Barbara takes a break
to eat a cookie.</p>
<h2 id="-frequently-asked-questions"><a class="header" href="#-frequently-asked-questions">ü§î Frequently Asked Questions</a></h2>
<p><em>Here are some standard FAQ to get you started. Feel free to add more!</em></p>
<h3 id="why-did-you-choose-barbara-to-tell-this-story"><a class="header" href="#why-did-you-choose-barbara-to-tell-this-story"><strong>Why did you choose Barbara to tell this story?</strong></a></h3>
<p><a href="../characters/barbara.html">Barbara</a> has years of rust experience that she brings to bear in her async learning experiences.</p>
<h3 id="what-are-the-morals-of-the-story"><a class="header" href="#what-are-the-morals-of-the-story"><strong>What are the morals of the story?</strong></a></h3>
<ul>
<li>
<p>Due to Barbara's long experience with rust, she knows most of the language
pretty well (except for things like async, and advanced concepts like pinned objects).
She generally <a href="./alan_started_trusting_the_rust_compiler_but_then_async.html">trusts the rust compiler</a>, and she's learned over the years that she
can learn how to use an unfamiliar library by reading the API docs.  As long
as she can get the types to line up and the code to compile, things generally
work as she expects.</p>
<p>But this is not the case with rust async:</p>
<ul>
<li>There can be new syntax to learn (e.g. async blocks)</li>
<li>It can be hard to find basic functionality (like <code>futures::future::join_all</code>)</li>
<li>It's not always clear how the ecosystem all fits together
(what functionality is part of tokio?  What is part of the
standard library?  What is part of other crates like the
<code>futures</code> crate?)</li>
<li>Sometimes it looks like there multiple ways to do something:
<ul>
<li>What's the difference between <code>futures::future::Future</code> and <code>std::future::Future</code>?</li>
<li>What's the difference between <code>tokio::time::Instant</code> and <code>std::time::Instant</code>?</li>
<li>What's the difference between <code>std::future::ready</code> and <code> futures::future::ok</code>?</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Barbara's has a lot to learn.  Her usual methods of learning how to use
new crates doesn't really work when learning tokio and async.  She wonders
if she actually should have read the long tokio tutorial before starting.
She realizes it will take her a while to build up the necessary foundation
of knowledge before she can be proficient in async rust.</p>
</li>
<li>
<p>There were several times where the compiler or the IDE gave helpful error
messages and Barbara appreciated these a lot.</p>
</li>
</ul>
<h3 id="what-are-the-sources-for-this-story"><a class="header" href="#what-are-the-sources-for-this-story"><strong>What are the sources for this story?</strong></a></h3>
<p>Personal experiences of the author</p>
<h3 id="how-would-this-story-have-played-out-differently-for-the-other-characters"><a class="header" href="#how-would-this-story-have-played-out-differently-for-the-other-characters"><strong>How would this story have played out differently for the other characters?</strong></a></h3>
<p>Other characters would likely have written all the same code as Barbara,
and probably would have run into the same problems.  But other characters
might have needed quite a bit longer to get to the solution.</p>
<p>For example, it was Barbara's experience with move-closures that led her to try 
adding the <code>move</code> keyword to the async block.  And it was her general
&quot;ambient knowledge&quot; of things that allowed her to remember that things
like the <code>futures</code> crate exist.  Other characters would have likely needed
to resort to an internet search or asking on a rust community.</p>
<h3 id="what-are-other-related-stories"><a class="header" href="#what-are-other-related-stories">What are other related stories?</a></h3>
<ul>
<li><a href="./barbara_makes_their_first_steps_into_async.html">Barbara makes their first steps in async</a> is Barbara in a slightly different universe.</li>
<li><a href="./alan_started_trusting_the_rust_compiler_but_then_async.html">Alan started trusting the rust compiler</a> is a similar story about a different character.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../vision/status_quo/barbara_needs_async_helpers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../vision/status_quo/barbara_tries_async_streams.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../vision/status_quo/barbara_needs_async_helpers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../vision/status_quo/barbara_tries_async_streams.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../../mermaid-init.js"></script>
        

        

    </body>
</html>
